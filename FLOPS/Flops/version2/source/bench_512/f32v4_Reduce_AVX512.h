/* f32v4_Reduce_AVX512.h
 * 
 * Author           : Alexander J. Yee
 * Date Created     : 06/05/2017
 * Last Modified    : 06/05/2017
 * 
 */

#ifndef _flops_f32v4_Reduce_AVX512_H
#define _flops_f32v4_Reduce_AVX512_H
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  Dependencies
#include <immintrin.h>
namespace Flops{
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
inline float reduce(__m512 z){
    __m256 y = _mm256_add_ps(
            _mm512_castps512_ps256(z),
            _mm256_castsi256_ps(_mm512_extracti64x4_epi64(_mm512_castps_si512(z), 1))
        );
    __m128 x = _mm_add_ps(_mm256_castps256_ps128(y), _mm256_extractf128_ps(y, 1));
    x = _mm_add_ps(x, _mm_unpackhi_ps(x, x));
    x = _mm_add_ps(x, _mm_shuffle_ps(x, x, 1));
    return _mm_cvtss_f32(x);
}
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
}
#endif
